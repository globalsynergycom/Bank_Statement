<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Загрузка выписки → GitHub /inbox</title>
  <style>
    :root{--brand:#0b3d91;--bg:#f6f8fb;--border:#dfe3eb;--muted:#5b6271}
    body{font-family:Inter,system-ui,Arial,sans-serif;max-width:760px;margin:40px auto;padding:0 12px}
    h1{color:var(--brand);margin:0 0 14px}
    .card{background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .btn{padding:10px 16px;border-radius:10px;border:1px solid var(--brand);background:var(--brand);color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--brand)}
    input[type=file]{padding:8px;border:1px solid var(--border);border-radius:10px;width:100%;background:#fff}
    .hint{color:var(--muted);font-size:14px}
    .ok{color:#0b7a2a}.err{color:#b00020}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .drop{border:2px dashed var(--border);border-radius:12px;padding:16px;text-align:center;color:var(--muted)}
    .drop.drag{border-color:var(--brand);color:var(--brand)}
    .links .btn{padding:8px 12px}
  </style>
</head>
<body>
  <h1>Загрузка банковской выписки → GitHub /inbox</h1>

  <div class="card">
    <p>Принимаем <b>.xlsx</b>, <b>.xls</b>, <b>.csv</b>. Файл уходит на Cloudflare Worker и сохраняется в репозитории в папку
      <code class="mono">/inbox</code>. GitHub Actions нормализует и положит результат в <code class="mono">/outbox</code>.</p>

    <div class="links row">
      <a id="lkInbox" class="btn secondary" target="_blank">Открыть /inbox</a>
      <a id="lkOutbox" class="btn secondary" target="_blank">Открыть /outbox</a>
      <a id="lkActions" class="btn secondary" target="_blank">Показать Actions</a>
    </div>

    <form id="form" onsubmit="return upload(event)">
      <div id="drop" class="drop">Перетащите файл сюда или выберите ниже</div>
      <div class="row">
        <input id="file" type="file" accept=".xlsx,.xls,.csv" required>
      </div>
      <div class="row">
        <button id="btn" class="btn" type="submit">Загрузить</button>
        <button type="button" class="btn secondary" onclick="resetForm()">Очистить</button>
      </div>
      <div id="status" class="hint"></div>
    </form>

    <p class="hint">Ограничение GitHub: ~25–50 МБ. Для больших выгрузок — разбейте файл.</p>
  </div>

  <script>
    // ⚙️ НАСТРОЙ НА СЕБЯ ↓↓↓
    const OWNER   = 'globalsynergycom';
    const REPO    = 'Bank_Statement';
    const BRANCH  = 'main';
    const UPLOAD_URL = 'https://bank-inbox-api.globalsynergycom.workers.dev/upload'; // ← твой воркер

    // Быстрые ссылки на репозиторий
    const base = `https://github.com/${OWNER}/${REPO}`;
    document.getElementById('lkInbox').href  = `${base}/tree/${BRANCH}/inbox`;
    document.getElementById('lkOutbox').href = `${base}/tree/${BRANCH}/outbox`;
    document.getElementById('lkActions').href= `${base}/actions`;

    function resetForm(){ form.reset(); status.textContent=''; }
    const form = document.getElementById('form');
    const status = document.getElementById('status');
    const drop = document.getElementById('drop');

    // drag&drop
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('drag');
      const f = e.dataTransfer.files?.[0]; if(f) document.getElementById('file').files = e.dataTransfer.files;
    });

    async function upload(e){
      e.preventDefault();
      const input = document.getElementById('file');
      const file = input.files[0];
      if(!file){ status.textContent='Выберите файл.'; return false; }
      if(!/\.(xlsx|xls|csv)$/i.test(file.name)){ status.textContent='Только .xlsx, .xls, .csv'; return false; }
      if(file.size > 50*1024*1024){ status.textContent='Файл >50 МБ. Уменьшите размер.'; return false; }

      const btn = document.getElementById('btn');
      btn.disabled = true; btn.textContent='Отправляем…';
      status.textContent='Загрузка файла в /inbox…';

      try{
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch(UPLOAD_URL, { method:'POST', body: fd });
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.error || ('HTTP '+res.status));

        status.innerHTML = `✅ Готово. Файл: <b>${file.name}</b><br>
          Коммит: <a target="_blank" href="${data.url || data.web_url}">${data.path || 'просмотр на GitHub'}</a><br>
          Через ~минуту проверьте <a target="_blank" href="${base}/tree/${BRANCH}/outbox">/outbox</a>.`;
        status.className='hint ok';
      }catch(err){
        status.textContent='Ошибка: '+err.message;
        status.className='hint err';
      }finally{
        btn.disabled=false; btn.textContent='Загрузить';
      }
      return false;
    }
  </script>
</body>
</html>
